<project
    name="iogen"
    default="iogen"
    basedir=".">

    <description>
	Ibis iogen target.

	Require prior definition of properties:
	ibis			location of ibis root
	default.classpath	refid of ibis classpath

	Optional prior definition of properties:
	default.classpath	refid of application classpath

	Targets:

	iogen	    rewrite files under ${iogen-build}
	    Set parameter:
	    iogen-build	root of tree to be iogen-ed
			    if undefined, value of ${build}

	iogen-files	    rewrite ${iogen-files}
	    Set parameter:
	    iogen-build	root of tree to be iogen-ed
			    if undefined, value of ${build}
	    iogen-files	list of files (separated by " ") to be
			    iogen-ed
			    if undefined, ${iogen-build}/**/*.class

    </description>

    <import file="${ibis}/build-properties.xml"/>

    <target name="property-iogen-build"
	    depends="property-init"
	    unless="iogen-build">
	    <!--
	    -->
	<echo message="iogen-build is undefined. Set it to the default value ${build}"/>
	<property name="iogen-build" location="${build}"/>
	<mkdir dir="${iogen-build}"/>
    </target>

    <target name="property-iogen-files"
	    depends="property-iogen-build"
	    unless="iogen-files">
	    <!--
	    depends="property-init,property-iogen-build"
	    -->
	<path id="prep-iogen-all-classes">
	    <fileset dir="${iogen-build}">
		<include name="**/*.class"/>
	    </fileset>
	</path>
	<pathconvert pathsep=" " property="iogen-files" refid="prep-iogen-all-classes">
	    <map from="${iogen-build}${file.separator}" to=""/>
	</pathconvert>
    </target>

    <target name="iogen-init"
	    depends="property-iogen-build,property-iogen-files"
	    unless="iogen.initialized">
	<property name="iogen.initialized" value="true"/>
    </target>

    <target name="iogen-files" depends="iogen-init">
	<mkdir dir="${iogen-build}"/>
	<echo level="debug" message="All files to be rewritten: ${iogen-files}"/>
	<if>
	    <not>
	    <isreference refid="app.classpath"/>
	    </not>
	    <then>
		<path id="app.classpath"/>
		<echo message="Define a default empty app.classpath"/>
	    </then>
	</if>
	<java   classname="ibis.frontend.io.IOGenerator"
		taskname="IOGenerator"
		dir="${iogen-build}"
		failonerror="true"
		maxmemory="256m"
		fork="true">
	    <arg line="-dir ${iogen-files}"/>
	    <classpath refid="default.classpath"/>
	    <classpath refid="app.classpath"/>
	</java>
    </target>

    <target name="iogen"
	    depends="iogen-init"
	    description="Preprocess serializable class files in the build tree">
	<echo level="debug" message="IOGen all class files under ${iogen-build}"/>
	<path id="iogen-all-classes">
	    <fileset dir="${iogen-build}">
		<include name="**/*.class"/>
		<exclude name="classlibs/**/*.class"/>
		<exclude name="ant-tasks/**/*.class"/>
	    </fileset>
	</path>
	<pathconvert pathsep=" " property="iogen-files" refid="iogen-all-classes">
	    <map from="${iogen-build}${file.separator}" to=""/>
	</pathconvert>
	<antcall target="iogen-files">
	    <param name="iogen-build" value="${build}"/>
	</antcall>
    </target>

</project>
