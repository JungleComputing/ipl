<project
    name="ibis.impl.net.gm.native"
    default="build"
    basedir=".">

    <description>
	Compile natives in this directory

	The shared target definitions require you to define:
	    local.includes	a property that contains include paths specific
				to this module

	Optional:
	    local.lib		the truncated name of the lib you want to create
    </description>

    <property name="native.dir" location="."/>
    <property name="ibis" location="../../../../.."/>

    <property name="local.lib" value="net_ibis_gm"/>

    <import file="${ibis}/build-files/build-properties.xml"/>
    <import file="${ibis}/build-files/build-native.xml"/>

    <target name="arch-init-unix" if="os-is-unix">
	<property name="gm.lib.dir"  location="${package.home.gm}/lib"/>
	<path id="net-gm-local.includes-ref">
	    <pathelement path="${package.home.gm}/include"/>
	</path>
    </target>

    <target name="arch-init-windows" if="os-is-windows">
	<property name="gm.lib.dir"  location="${package.home.gm}/examples"/>
	<path id="net-gm-local.includes-ref">
	    <pathelement path="${package.home.gm}"/>
	</path>
    </target>

    <target name="arch-init-mac" if="os-is-mac">
	<echo message="No info on gm lib location on this OS"/>
    </target>

    <target name="arch-init" depends="property-init, native-init, arch-init-windows, arch-init-unix, arch-init-mac">

	<property name="local.includes" refid="net-gm-local.includes-ref"/>

	<!--
	  If both libgm.a and libgm.so exist, I found no way to persuade cpptasks
	  to select libgm.a and do a fully resolved link to libnet_ibis_gm.so.
	  So, we copy libgm.a to the local build/lib and hope nobody minds the
	  manyfold distribution of libs.
	-->
	<!--
	<libset id="local.libset-ref"
		dir="${gm.lib.dir}"
		libs="gm"/>
	-->
	<libset id="local.libset-ref"
	    dir="${ibis}/lib/natives"
		libs="gm"/>
    </target>

    <target name="build" depends="arch-init">
	<maplibrary
		property="gm.path"
		name="${gm.lib.dir}/libgm.a"
		outtype="static"/>
	<!--
	See comments above
	<echo level="warning" message="The GM library is ${gm.path}"/>
	-->
	<copy file="${gm.path}" todir="${ibis}/lib/natives"/>
	<antcall inheritRefs="true" target="native"/>
	<!--
	<antcall inheritRefs="true" target="net-gm-lib"/>
	-->
    </target>

</project>
