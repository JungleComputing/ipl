<project
    name="iogen"
    default="iogen"
    basedir=".">

    <description>
	Ibis iogen target.

	Require prior definition of properties:
	ibis			location of ibis root
	default.classpath	refid of ibis classpath

	Optional prior definition of properties:
	app.classpath		refid of application classpath

	Targets:

	iogen	    rewrite files under ${iogen-build}
	    Set parameter:
	    iogen-build	root of tree to be iogen-ed
			    if undefined, value of ${build}

	iogen-files	    rewrite ${iogen-files}
	    Set parameter:
	    iogen-build	root of tree to be iogen-ed
			    if undefined, value of ${build}
	    iogen-files	list of files (separated by " ") to be
			    iogen-ed
			    if undefined, ${iogen-build}/**/*.class

    </description>

    <target name="property-iogen-build"
	    depends="property-init"
	    unless="iogen-build">
	<echo message="iogen-build is undefined. It is set to ${build}"/>
	<property name="iogen-build" location="${build}"/>
	<mkdir dir="${iogen-build}"/>
    </target>

    <target name="property-iogen-files"
	    depends="property-iogen-build"
	    unless="iogen-files">
	<property name="iogen-files" value="."/>
    </target>

    <target name="has-app-classpath">
	<condition property="has-app.classpath">
	    <isreference refid="app.classpath"/>
	</condition>
    </target>

    <target name="set-app-classpath"
	    depends="has-app-classpath"
	    unless="has-app.classpath">
	<path id="app.classpath"/>
	<echo message="Define a default empty app.classpath"/>
    </target>


    <target name="iogen-init"
	    depends="property-iogen-files,set-app-classpath"
	    unless="iogen.initialized">
	<property name="iogen.initialized" value="true"/>
    </target>

    <target name="iogen-files" depends="iogen-init">
	<mkdir dir="${iogen-build}"/>
	<echo level="debug" message="All files to be rewritten: ${iogen-files}"/>

	<java   classname="ibis.frontend.io.IOGenerator"
		taskname="IOGenerator"
		dir="${iogen-build}"
		failonerror="true"
		maxmemory="512m"
		fork="true">
		<arg line="-silent -dir ${iogen-files}"/>
	    <classpath refid="default.classpath"/>
	    <classpath refid="app.classpath"/>
	</java>
    </target>

    <target name="iogen"
	    depends="iogen-init">
	<echo level="warning" message="IOGen all class files under ${iogen-build}"/>
	<antcall target="iogen-files">
	    <param name="iogen-build" value="${build}"/>
	</antcall>
    </target>

</project>
