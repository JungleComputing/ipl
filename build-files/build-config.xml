<project
    name="build-config"
    default="configure"
    basedir=".">

    <description>
      Install-time configuration.
      Figure out where the packages are that we depend on.
    </description>

    <target name="config.previous"
	    depends="config-workstation"
	    if="config.has-previous">
	<echo message="Read previous configuration from build-properties.cache"/>
	<property file="build-properties.cache"/>
    </target>

    <target name="config.workstation"
	    depends="config-workstation"
	    if="config.is-workstation">
	    <property file="${ibis}/build-files/build-properties.default"/>
    </target>

    <target name="config-workstation">
	<condition property="config.has-previous">
	    <available file="build-properties.cache"/>
	</condition>
	<condition property="config.is-workstation">
	    <not>
		<isset property="config.has-previous"/>
	    </not>
	</condition>
    </target>

    <condition property="java-ok">
	<or>
	    <contains string="${java.version}" substring="1.4"/>
	    <contains string="${java.version}" substring="1.5"/>
	    <contains string="${java.version}" substring="1.6"/>
	</or>
    </condition>

    <target name="java-version-test" depends="java-home-test" unless="java-ok">
	<fail message="Java version ${java.version} is not supported. A 1.4 or 1.5 version is required for Ibis.">
	</fail>
    </target>

    <target name="java-home-test" unless="env.JAVA_HOME">
	<fail>Environment variable JAVA_HOME is not set!</fail>
    </target>

    <target name="config-init"
	    depends="java-version-test,config.workstation,config.previous">
	<property name="JAVA_HOME_ENV" value="${env.JAVA_HOME}"/>
    </target>

    <property environment="env"/>

    <target name="-config-sleep" unless="called-from-configure">
	<echo>
----------------------------------------------------------------
Now, your Ibis build is being configured under ${ibis}.

If you don't have any fast local networks for which a special
Ibis module is required, you may skip the following message
by just waiting for 30 seconds, after which the build will continue.

If you wish to configure Ibis modules for fast local networks,
you have to do some extra configuration. To do so,
first interrupt this build, and then type:
  ant configure
to the command line, and answer questions.
After you did this optional configuration, you must again type:
  ant
to the command line.
If you don't know the answer, or don't have the native modules
that the fast local network module depends on, just waiting for
30 seconds is usually OK.
----------------------------------------------------------------
</echo>
	<sleep seconds="30"/>
	<property name="install.home.gm" value="${default.home.gm}"/>
	<property name="install.home.daslib" value="${default.home.daslib}"/>
	<property name="install.home.lfc" value="${default.home.lfc}"/>
	<property name="install.home.panda" value="${default.home.panda}"/>
	<property name="install.home.mpi" value="${default.home.mpi}"/>
    </target>

    <target name="-config-build-1" depends="-config-sleep">

	<property name="config.home.ibis" location="${ibis}"/>
	<property name="config.home.gm" location="${install.home.gm}"/>
	<property name="config.home.daslib" location="${install.home.daslib}"/>
	<property name="config.home.lfc" location="${install.home.lfc}"/>
	<property name="config.home.panda" location="${install.home.panda}"/>
	<property name="config.home.mpi" location="${install.home.mpi}"/>

	<delete file="build-properties.cache"/>
	<echo	file="build-properties.cache"
		append="true">default.home.panda  = ${config.home.panda}
</echo>
	<echo	file="build-properties.cache"
		append="true">default.home.daslib = ${config.home.daslib}
</echo>
	<echo	file="build-properties.cache"
		append="true">default.home.lfc    = ${config.home.lfc}
</echo>
	<echo	file="build-properties.cache"
		append="true">default.home.mpi    = ${config.home.mpi}
</echo>
	<echo	file="build-properties.cache"
		append="true">default.home.gm     = ${config.home.gm}
</echo>
	<replace
		file="${ibis}/build-properties.cache"
		token="${file.separator}"
		value="/"/>

	<copy	file="${ibis}/build-properties"
		tofile="${ibis}/build-properties.backup"
		failonerror="false"
		overwrite="true">
	</copy>
	<copy	file="${ibis}/src/scripts/build-properties.in"
		tofile="${ibis}/build-properties"
		overwrite="true">
	</copy>

	<replace
		file="${ibis}/build-properties"
		token="@JAVA@"
		value="${JAVA_HOME_ENV}"/>
	<replace
		file="${ibis}/build-properties"
		token="@IBIS@"
		value="${config.home.ibis}"/>
	<replace
		file="${ibis}/build-properties"
		token="@GM_HOME@"
		value="${config.home.gm}"/>
	<replace
		file="${ibis}/build-properties"
		token="@DASLIB_HOME@"
		value="${config.home.daslib}"/>
	<replace
		file="${ibis}/build-properties"
		token="@LFC_HOME@"
		value="${config.home.lfc}"/>
	<replace
		file="${ibis}/build-properties"
		token="@PANDA_HOME@"
		value="${config.home.panda}"/>
	<replace
		file="${ibis}/build-properties"
		token="@MPI_HOME@"
		value="${config.home.mpi}"/>
	<replace
		file="${ibis}/build-properties"
		token="${file.separator}"
		value="/"/>

	<!--
	==============================================================
	    Generate configuration.sh, on windows too, for it could be Cygwin.
	-->

	<condition property="JIT_OPTS" value="${env.JIT_OPTS}">
	    <isset property="env.JIT_OPTS"/>
	</condition>
	<condition property="JIT_OPTS" value="">
	    <not>
		<isset property="env.JIT_OPTS"/>
	    </not>
	</condition>

	<condition property="is-windows">
	    <os family="windows"/>
	</condition>

	<property name="config.javac" location="${JAVA_HOME_ENV}/bin/javac"/>

	<mkdir dir="${ibis}/bin"/>
	<echo
		file="${ibis}/configuration.sh">#!/bin/bash
# Shell variables to describe Ibis configuration
JAVA_ROOT="${JAVA_HOME_ENV}"
# JAVA_ROOT=/usr/local/ibm-java/IBMJava2-141
# JAVA_ROOT=/usr/local/sun-java/jdk1.4
# JAVA_ROOT=/usr/local/sun-java/j2sdk1.5.0
JAVAC="${config.javac}"
JIT_OPTS="${JIT_OPTS}"
IBIS_ROOT="${ibis}"
BCEL="${package.home.bcel}"
IBIS_CONFIG_SEEN=1
</echo>

	<copy
		file="${ibis}/src/scripts/ns-env.in"
		tofile="${ibis}/bin/ns-env"/>
	<replace file="${ibis}/bin/ns-env" token="@IBIS_NS_PORT@" value="9826"/>
	<replace file="${ibis}/bin/ns-env" token="@IBIS_NS_HOST@" value="localhost"/>
	<chmod file="${ibis}/bin/ns-env" perm="+x"/>
    </target>

    <target name="-config-build-windows" if="is-windows">
	<echo
	    file="${ibis}/configuration.bat">@rem Windows cmd variables to describe Ibis configuration
@set JAVA_ROOT=${JAVA_HOME_ENV}
@set JAVAC=${config.javac}
@set JIT_OPTS=${JIT_OPTS}
@set IBIS_ROOT=${ibis}
@set BCEL=${package.home.bcel}
@set IBIS_CONFIG_SEEN=1
</echo>

	<copy
		file="${ibis}/src/scripts/ns-env.in"
		tofile="${ibis}/bin/ns-env.bat">
	</copy>
	<replace file="${ibis}/bin/ns-env.bat" token="@IBIS_NS_PORT@" value="9826"/>
	<replace file="${ibis}/bin/ns-env.bat" token="@IBIS_NS_HOST@" value="localhost"/>
	<replaceregexp
	    file="${ibis}/bin/ns-env.bat"
		flags="g"
		match="(.*)="
		replace="set \1="/>
	<replace
	    file="${ibis}/bin/ns-env.bat"
		token="#"
		value="rem "/>
	<replace
	    file="${ibis}/bin/ns-env.bat"
		token="export"
		value="rem "/>
    </target>

    <target name="-config-build-properties"
	depends="-config-build-1,-config-build-windows"/>

    <target name="-config-lazy-build-properties"
	    unless="build-properties-available">
	<antcall inheritRefs="true" target="-config-build-properties"/>
    </target>


    <target name="config-init-initial" depends="config-init">
	<condition property="build-properties-available">
	    <available file="build-properties"/>
	</condition>
	<antcall inheritRefs="true" target="-config-lazy-build-properties"/>
    </target>

    <target name="configure"
	    depends="config-init"
	    description="Ibis build configuration for high-speed LAN modules">

	<input
		message="Please enter the install directory of gm: [${default.home.gm}] "
		addproperty="install.home.gm"
		defaultvalue="${default.home.gm}"/>
	<input
		message="Please enter the install directory of daslib: [${default.home.daslib}] "
		addproperty="install.home.daslib"
		defaultvalue="${default.home.daslib}"/>
	<input
		message="Please enter the install directory of lfc: [${default.home.lfc}] "
		addproperty="install.home.lfc"
		defaultvalue="${default.home.lfc}"/>
	<input
		message="Please enter the install directory of panda: [${default.home.panda}] "
		addproperty="install.home.panda"
		defaultvalue="${default.home.panda}"/>
	<input
		message="Please enter the install directory of mpi: [${default.home.mpi}] "
		addproperty="install.home.mpi"
		defaultvalue="${default.home.mpi}"/>

	<property name="called-from-configure" value="true"/>
	<antcall inheritRefs="true" target="-config-build-properties"/>
    </target>

</project>
