<project
    name="run"
    default="run1"
    basedir=".">

    <description>
	Ibis application run target.

	Require prior definition of properties:
	ibis			location of ibis root

	Targets:

	run1	run the application as a parallel program,
		with a single instance, using TCP ibis.
		Set parameter:
		runjob		main class name and arguments
		java-args	flags for java
		ibis-run-args	flags for ibis-run

	run2	run the application as a parallel program,
		with two instances, using TCP ibis.
		Set parameter:
		runjob		main class name and arguments
		java-args	flags for java
		ibis-run-args	flags for ibis-run

	runseq	run the application as a sequential program.
		Set parameter:
		runjob		main class name and arguments
		java-args	flags for java
		ibis-run-args	flags for ibis-run

    </description>

    <property name="ibis-run-args" value=""/>
    <property name="java-args" value=""/>

    <target name="set-ibis-name">

	<condition property="ibis-name" value="tcp">
	    <not>
		<isset property="ibis-name"/>
	    </not>
	</condition>

	<condition property="define-ibis-name" value="&quot;-Dibis.name^=${ibis-name}&quot;">
	    <os family="windows"/>
	</condition>
	<condition property="define-ibis-name" value="-Dibis.name=${ibis-name}">
	    <not>
		<isset property="define-ibis-name"/>
	    </not>
	</condition>
    </target>

    <target name="run2"
	depends="set-ibis-name">
	<exec dir="${basedir}"
	      executable="${ibis}/bin/ibis-run"
	      vmlauncher="false"
	      spawn="true">
	    <arg line="-ns localhost -ns-port 46789 -hostno 1 -nhosts 2 ${ibis-run-args}"/>
	    <arg value="${define-ibis-name}"/>
	    <arg line="${java-args} ibis.util.Postpone 2 -o ant-test.out ${runjob}"/>
	</exec>
	<exec dir="${basedir}"
	      executable="${ibis}/bin/ibis-run"
	      timeout="500000"
	      failonerror="true"
	      vmlauncher="false">
	    <arg line="-ns localhost -ns-port 46789 -hostno 0 -nhosts 2 ${ibis-run-args}"/>
	    <arg value="${define-ibis-name}"/>
	    <arg line="${java-args} ${runjob}"/>
	</exec>
    </target>


    <target name="do-prun"
	depends="set-ibis-name">
	<condition property="prun-nprocs" value="2">
	    <not>
		<isset property="prun-nprocs"/>
	    </not>
	</condition>
	<echo message="Running parallel test on ${prun-nprocs} nodes, ${ibis-name} Ibis"/>
	<exec dir="${basedir}"
	    executable="/usr/local/VU/reserve.sge/bin/prun"
	      vmlauncher="false">
	      <arg line="-1 ${ibis}/bin/ibis-prun ${prun-nprocs} ${ibis-run-args}"/>
	    <arg value="${define-ibis-name}"/>
	    <arg line="${java-args} ${runjob}"/>
	</exec>
    </target>

    <target name="run1"
	    depends="set-ibis-name">
	<exec dir="${basedir}"
	      executable="${ibis}/bin/ibis-run"
	      timeout="500000"
	      failonerror="true"
	      vmlauncher="false">
	    <arg line="-ns localhost -ns-port 46789 -hostno 0 -nhosts 1 ${ibis-run-args}"/>
	    <arg value="${define-ibis-name}"/>
	    <arg line="${java-args} ${runjob}"/>
	</exec>
    </target>

    <target name="runseq">
	<exec dir="${basedir}"
	      executable="${ibis}/bin/ibis-run"
	      timeout="500000"
	      failonerror="true"
	      vmlauncher="false">
	      <arg line="${ibis-run-args} -- ${java-args} ${runjob}"/>
	</exec>
    </target>

    <target name="set-par-jargs-def" unless="test-par-java-args">
	<property name="jargs" value=""/>
    </target>

    <target name="set-par-jargs-par" if="test-par-java-args">
	<property name="jargs" value="${test-par-java-args}"/>
    </target>

    <target name="set-par-jargs"
	depends="set-par-jargs-def,set-par-jargs-par"/>

    <target name="set-seq-jargs-def" unless="test-seq-java-args">
	<property name="jargs" value=""/>
    </target>

    <target name="set-seq-jargs-seq" if="test-seq-java-args">
	<property name="jargs" value="${test-seq-java-args}"/>
    </target>

    <target name="set-seq-jargs"
	depends="set-seq-jargs-def,set-seq-jargs-seq"/>

    <target name="test-par"
	description="Run a parallel test if the property 'test-par-run' is set"
	depends="set-par-jargs"
	if="test-par-run">
	<echo message="Running parallel test on two JVM instances"/>
	<antcall target="run2">
	    <param name="runjob" value="${test-par-run}"/>
	    <param name="java-args" value="${jargs}"/>
	</antcall>
    </target>

    <target name="test-prun"
	    description="Run a parallel test with prun if the property 'test-par-run' is set"
	    depends="build,set-par-jargs"
	    if="test-par-run">
	<antcall target="do-prun">
	    <param name="runjob" value="${test-par-run}"/>
	    <param name="java-args" value="${jargs}"/>
	</antcall>
    </target>

    <target name="test-seq"
	if="test-seq-run"
	depends="set-seq-jargs"
	description="Run a sequential test if the property 'test-seq-run' is set">
	<echo message="Running sequential test"/>
	<antcall target="run1">
	    <param name="runjob" value="${test-seq-run}"/>
	    <param name="java-args" value="${jargs}"/>
	</antcall>
    </target>

    <!-- Default test target, for if the application does not have one.
	 Does test-par as well as test-seq.
    -->
    <target name="test"
	    description="Build, run sequential test, run parallel test"
	    depends="build,test-seq,test-par">
    </target>

    <target name="jar"
	    depends="build"
	    description="Build a Jar file for an application">
	    <basename file="." property="application-name"/>
	    <jar destfile="${build}/${application-name}.jar"
		 basedir="${build}"
		 includes="**/*.class">
		 <manifest>
		     <attribute name="Main-Class" value="${main-class}"/>
		 </manifest>
	    </jar>
    </target>

</project>
