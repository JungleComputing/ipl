#!/bin/sh

PRG="$0"

# resolve symlinks
while [ -h "$PRG" ] ; do
    ls=`ls -ld "$PRG"`
    link=`expr "$ls" : '.*-> \(.*\)$'`
    if expr "$link" : '/.*' > /dev/null; then
    PRG="$link"
    else
    PRG=`dirname "$PRG"`"/$link"
    fi
done

dir=`dirname "$PRG"`
dir=`cd "$dir" && pwd`

. $dir/../configuration.sh


#start of script template

if [ -z "$1" -o $# -le 0 ]
then
	echo "Usage:"
	echo "  $0 <JVM PARAMS> <CLASS NAME> <APPLICATION PARAMS>"
	echo "or, when using prun:"
	echo "  prun -1 -v -no-panda $0 <JVM PARAMS> <CLASS NAME> <APPLICATION PARAMS>"
	exit 1
fi

JAVACLASSPATH=$CLASSPATH:build:$IBIS_ROOT/classlibs:$IBIS_ROOT/build:.:

#needed for ibm 1.3 JITs and SMPs
if [[ $JAVA_ROOT == *1.3* ]] ; then
	export LD_ASSUME_KERNEL=2.2.5
fi

#disable panda interrupts
#export IBP_NO_INTR=1

# fix panda/lfc flow control
#export LFC_SEND_COPY_ASIDE=1
#export PAN_SYS_CREDITS=65535

if [ -z "$LFC_INTR_FIRST" ] ; then
	export LFC_INTR_FIRST=100
fi
if [ -z "$IBP_SEND_SYNC" ] ; then
	export IBP_SEND_SYNC=100 
fi
if [ -z "$PAN_COMM_NO_IDLE_POLL" ] ; then
	export PAN_COMM_NO_IDLE_POLL=1
fi

#not needed any more, and not portable --Rob
#Dlibpath="-Dsun.boot.library.path=$IBIS_ROOT/build/lib:$JAVA_ROOT/jre/bin:$JAVA_ROOT/jre/lib/i386"

Dlibpath="-Djava.library.path=$IBIS_ROOT/build/lib:.:$LD_LIBRARY_PATH:"

# This is the location where all ibis native libs must go.
# It must be *one* dir.
Dibislibs="-Dibis.library.path=$IBIS_ROOT/build/lib"

#PROFILING=-Xhprof:cpu=samples,file=profile.$1,depth=3
PROFILING=

cpumask="1"
attach=0
noJIT=0
dedicated_nameserver=0

JAVA_EXEC=java
Xbootclasspath="-Xbootclasspath/p:$JAVACLASSPATH"

action=eval

. $IBIS_ROOT/bin/ns-env

Dns_port="-Dibis.name_server.port=$IBIS_NAMESERVER_PORT"
Dns_server="-Dibis.name_server.host=$IBIS_NAMESERVER_HOST"
Dns_pool="-Dibis.name_server.key=$PANDA_HOST_PORT_KEY"

dir=$PWD

while [ $# -gt 0 ]
do
        qarg="'"$1"'"
        # qarg="$1"
# echo now inspect argument $1 -- left $#
        case "$1" in
	-attach)
		attach=1
		;;
        -cd)
		shift
		dir="$1"
                ;;
        -cpu)
		shift
		cpumask="$1"
                ;;
	-karmi)
		Xbootclasspath=""
		JAVACLASSPATH="$CLASSPATH:build:$KARMI/karmi.jar:$IBIS_ROOT/build:"
		;;
	-karmi-gm)
		Xbootclasspath=""
		Dlibpath="$Dlibpath$KARMI/lib:"
		JAVACLASSPATH="$CLASSPATH:build:$KARMI/karmi.jar:$IBIS_ROOT/build:"
		;;
	-key)
		shift
		Dns_pool="-Dibis.name_server.key=$1"
		;;
	-ip-map)
		shift
		ip_map="$1"
		ip_addr=`$IBIS_ROOT/bin/ip_map.perl $ip_map \`hostname\``
		JIT_OPTS="$JIT_OPTS -Dibis.util.ip.address=$ip_addr"
		# This is required if Sun's RMI is used
		JIT_OPTS="$JIT_OPTS -Djava.rmi.server.hostname=$ip_addr"
		export HOSTS="`$IBIS_ROOT/bin/ip_map.perl $ip_map $HOSTS`"
		# echo HOSTS $HOSTS
		# echo PRUN_HOSTNAMES $PRUN_HOSTNAMES
		export PRUN_HOSTNAMES="`$IBIS_ROOT/bin/ip_map.perl $ip_map $PRUN_HOSTNAMES`"

		# echo PRUN_HOSTNAMES $PRUN_HOSTNAMES
		;;
	-jdb)
		JAVA_EXEC=jdb
		;;
	-no-jit)
		noJIT=1
		;;
	-no-pool)
		no_pool=1
		;;
	-n)
		action=echo
		;;
	-ns)
		shift
		Dns_server="-Dibis.name_server.host=$1"
		;;
	-ns-port)
		shift
		Dns_port="-Dibis.name_server.port=$1"
		;;
	-ns-d)
		dedicated_nameserver=1
		;;
	-pg)
		shift
		gprof="$1"
		;;
	-p)
		shift
		prof="$1"
		;;
        *)      java_args="$java_args $qarg"
                ;;
        esac
        shift
done


NHOSTS=`echo $PRUN_HOSTNAMES | awk '{print NF}'`
if [ -z "$no_pool" ] ; then
	Dpool_total="-Dibis.pool.total_hosts=$NHOSTS"
	Dpool_host_num="-Dibis.pool.host_number=$PRUN_CPU_RANK"
	Dpool_host_names="-Dibis.pool.host_names=\"$HOSTS\""
	if [ $PRUN_CPU_RANK -eq 0 ] ; then
		$JAVA_ROOT/bin/java -version
	fi
else
	Dpool_total=
	Dpool_host_num=
	Dpool_host_names=
fi
if [ $noJIT -eq 1 ]
then
	JIT_OPTS="$JIT_OPTS -Djava.compiler=NONE"
fi
if [ $attach -eq 1 ]
then
	JIT_OPTS="$JIT_OPTS -Xdebug -Xnoagent -Xrunjdwp:transport=dt_socket,address=8000,server=y,suspend=n -Djava.compiler=NONE"
fi
if [ ! -z "$prof" ]
then
	JIT_OPTS="$JIT_OPTS -Xrunhprof:cpu=samples,depth=8,thread=y,file=$prof.$PRUN_CPU_RANK -Djava.compiler=NONE"
fi
if [ ! -z "$gprof" ]
then
	# JIT_OPTS="$JIT_OPTS -Xrunhprof:cpu=times,depth=8,thread=y,file=$gprof.$PRUN_CPU_RANK -Djava.compiler=NONE"
	JIT_OPTS="$JIT_OPTS -Xrunhprof:cpu=times,depth=8,thread=y,file=$gprof.$PRUN_CPU_RANK"
fi

if [[ $JAVA_ROOT == *sun* ]] ; then
	JIT_OPTS="$JIT_OPTS -server"
fi
if [[ $JAVA_ROOT == *ibm* ]] ; then
	JIT_OPTS="$JIT_OPTS -Xcomp"
fi

DEFAULT_USE_JAVA_WRAPPER=1

WRAPPER=$IBIS_ROOT/bin/java_wrapper
wrapper_name="$WRAPPER -cpu $cpumask -cd $dir"
if [ ! -x $WRAPPER ] ; then
	wrapper_name=""
fi

# Given a list, return the last element
function last_array_elt () {
	local last
	for h ; do last=$h ; done
	echo $last
}

# Given a list, return a list with the last element stripped
# bash cannot slice for you, so we use an intermediate array
# for the manipulations.
function strip_array () {
	local i=0
	local -a ARRAY
	for h ; do
		ARRAY[$i]=$h
		i=`expr $i + 1`
	done
	local RESULT="${ARRAY[0]}"
	for (( i = 1; i < $# - 1; i++ )) ; do
		RESULT="$RESULT ${ARRAY[$i]}"
	done
	echo "$RESULT"
}

i_am_nameserver=0
if [ $dedicated_nameserver -eq 1 ]
then
	# A dedicated nameserver is run on HOSTS[#HOSTS - 1]
	# The last entry in HOSTS and PRUN_HOSTNAMES is stripped.

	ns=`last_array_elt $HOSTS`
	# echo ns $ns
	Dns_server="-Dibis.name_server.host=$ns"

	NHOSTS=`expr $NHOSTS - 1`
	Dpool_total="-Dibis.pool.total_hosts=$NHOSTS"
	# echo Dpool_total $Dpool_total

	export HOSTS=`strip_array $HOSTS`
	Dpool_host_names="-Dibis.pool.host_names=\"$HOSTS\""
	# echo Dpool_host_names $Dpool_host_names

	export PRUN_HOSTNAMES=`strip_array $PRUN_HOSTNAMES`

	if [ $PRUN_CPU_RANK -eq $NHOSTS ] ; then
		i_am_nameserver=1
	fi
fi

# the -Xmx1024M must be here for the SUN JIT, it does not allocate enough mem for some satin apps --Rob

if [ $i_am_nameserver -eq 1 ]
then
	echo Start run-once name server on `hostname`
	$action $wrapper_name \
		$JAVA_ROOT/bin/$JAVA_EXEC \
		-classpath $JAVACLASSPATH \
		ibis.impl.nameServer.tcp.NameServer -single
else
	# echo HOSTS '"'$HOSTS'"'
	# echo PRUN_HOSTNAMES '"'$PRUN_HOSTNAMES'"'
	$action $wrapper_name \
		$JAVA_ROOT/bin/$JAVA_EXEC \
		$JIT_OPTS -Xmx1024M \
		$Dlibpath $Dibislibs \
		$Dpool_host_num $Dpool_total $Dpool_host_names \
		$Dns_pool $Dns_port $Dns_server \
		-Dibis.name_server.retry=yes \
		$Xbootclasspath \
		$PROFILING \
		-classpath $JAVACLASSPATH \
		$java_args
fi
