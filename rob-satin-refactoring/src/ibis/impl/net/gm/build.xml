<project
    name="ibis.impl.net.gm.native"
    default="build"
    basedir=".">

    <description>
	Compile natives in this directory

	Expect to inherit the following properties:
	    native.dir		the directory of this build
	    ibis		the root of the ibis source tree
	    native-path		${native.dir} relative to ${ibis}
	    build		the root of the ibis build tree
	    default.classpath	a ref property with default classpath

	The shared target definitions require you to define:
	    local.includes	a property that contains include paths specific
				to this module

	Optional:
	    local.lib		the truncated name of the lib you want to create
    </description>

    <property name="ibis" location="../../../.."/>

    <property name="local.lib" value="net_ibis_gm"/>

    <import file="${ibis}/build-files/build-properties.xml"/>
    <import file="${ibis}/build-files/build-native.xml"/>

    <target name="arch-init" depends="property-init, native-init">
	<if>
	    <os family="unix"/>
	    <then>
		<property name="gm.lib.dir"  location="${package.home.gm}/lib"/>
		<path id="net-gm-local.includes-ref">
		    <pathelement path="${package.home.gm}/include"/>
		</path>
	    </then>
	<elseif>
	    <os family="windows"/>
	    <then>
		<property name="gm.lib.dir"  location="${package.home.gm}/examples"/>
		<path id="net-gm-local.includes-ref">
		    <pathelement path="${package.home.gm}"/>
		</path>
	    </then>
	</elseif>
	<else>
	    <echo message="No info on gm lib location on this OS"/>
	</else>
	</if>

	<property name="local.includes" refid="net-gm-local.includes-ref"/>

	<!--
	  If both libgm.a and libgm.so exist, I found no way to persuade cpptasks
	  to select libgm.a and do a fully resolved link to libnet_ibis_gm.so.
	  So, we copy libgm.a to the local build/lib and hope nobody minds the
	  manyfold distribution of libs.
	-->
	<!--
	<libset id="local.libset-ref"
		dir="${gm.lib.dir}"
		libs="gm"/>
	-->
	<libset id="local.libset-ref"
		dir="${ibis}/build/lib"
		libs="gm"/>
    </target>

    <target name="build" depends="arch-init">
	<maplibrary
		property="gm.path"
		name="${gm.lib.dir}/libgm.a"
		outtype="static"/>
	<!--
	See comments above
	<echo level="warning" message="The GM library is ${gm.path}"/>
	-->
	<copy file="${gm.path}" todir="${ibis}/build/lib"/>
	<antcall inheritRefs="true" target="native-compile"/>
	<!--
	<antcall inheritRefs="true" target="net-gm-lib"/>
	-->
    </target>

</project>
