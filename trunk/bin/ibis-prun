#!/bin/sh

# This script can be used for running ibis applications with prun (which
# probably is only available on our own DAS system).

if [ -z "$IBIS_HOME" ];  then
    echo "please set IBIS_HOME to the location of your Ibis installation" 1>&2
    exit 1
fi

NHOSTS=`echo $PRUN_HOSTNAMES | awk '{print NF}'`
case X$1 in
X$PRUN_CPU_RANK)
	case X$2 in
	X$NHOSTS)
		# User probably forgot to pass the -no-panda flag
		shift
		shift
		;;
	esac
	;;
esac

pool="$PRUN_ENV"

function usage () {
cat << 'EOF'
Usage:
    prun -no-panda ibis-prun <ibis-prun params> <jvm params> <classname> <application params>
The first parameter that is not recognized as an option to ibis-prun
terminates the ibis-prun parameters.
The ibis-prun parameters are:
-pool <pool>
    use <pool> for identification with the nameserver, instead of the
    prun-supplied one.
-no-pool
    don't pass on any node-pool information to the application.
-ns <nameserver>[:<port>]
    specifies the hostname and port on which the nameserver runs. If not
    specified, ibis-prun picks the first host, unless -no-ns is specified,
    in which case ibis-prun assumes that another way is used to pass on the
    nameserver location (for instance an ibis.properties file).
-no-ns
    no nameserver info is supplied by ibis-prun. See above.
-cpdir <dir>
    add all jar files in the specified directory to the classpath.
-?
-h
-help
--help
    print this message
--
    terminates the parameters for ibis-prun; following parameters are passed
    on to java, even if they would be acceptable to ibis-prun
EOF
	exit 1
}

if [ -z "$1" -o $# -le 0 ]
then
	usage
fi

#
# Some defaults ...
#

no_pool=0
ibislib=$IBIS_HOME/lib/natives

#
# parse arguments
#

nameserver_specified=0
no_nameserver=0

# Jar-files from library.
LIBCLASSPATH=""
add_to_libclasspath () {
    JARFILES=`cd "$1" && ls *.jar 2>/dev/null`
    for i in ${JARFILES} ; do
	if [ -z "$LIBCLASSPATH" ] ; then
	    LIBCLASSPATH="$1/$i"
	else
	    LIBCLASSPATH="$LIBCLASSPATH:$1/$i"
	fi
    done
}


while [ $# -gt 0 ]
do
# echo now inspect argument $1 -- left $#
        case "$1" in
	-ibislib)
		shift
		ibislib="$1"
		;;
	-pool)
		shift
		pool="$1"
		;;
	-no-pool)
		no_pool=1
		;;
	-no-ns)
		no_nameserver=1
		;;
	-ns)
		nameserver_specified=1
		shift
		Dns_server="-Dibis.registry.serverAddress=$1"
		;;
	-cpdir)
		shift
		add_to_libclasspath "$1"
		;;
	-\?|-h|-help|--help)
		usage
		;;
	--)
		shift
		break
		;;
        *)      
		break
                ;;
        esac
        shift
done

if [ $no_nameserver -eq 0 ]
then
    if [ $nameserver_specified -eq 0 ]
    then
	for i in $HOSTS
	do
	    Dns_server="-Dibis.registry.serverAddress=$i"
	    break
	done
    fi
fi

export ibislib

# Put value of environment variable CLASSPATH in front, if present.
if [ -z "$CLASSPATH" ] ; then
    CLASSPATH="$LIBCLASSPATH"
else 
    CLASSPATH="$CLASSPATH:$LIBCLASSPATH"
fi

if [ $no_pool -eq 0 ]
then
	. $IBIS_HOME/bin/ibis-run \
		-Dibis.pool.host_number=$PRUN_CPU_RANK \
		-Dibis.pool.total_hosts=$NHOSTS \
		$Dns_server \
		-Dibis.registry.pool="$pool" \
		-Dibis.pool.host_names="$HOSTS" \
		"$@"
else
	. $IBIS_HOME/bin/ibis-run \
		-Dibis.registry.pool="$pool" \
		$Dns_server \
		"$@"
fi
