<project
    name="repmi-app"
    default="build"
    basedir=".">

    <import file="${ibis}/build-properties.xml"/>
    <import file="${ibis}/build-iogen.xml"/>
    <import file="${ibis}/build-native.xml"/>
    <import file="${ibis}/apps/build-run.xml"/>

    <description>
	Ibis rmi application build.
    </description>

    <target name="property-rmic-build" unless="build">
	<echo message="build is undefined. Set it to the default value"/>
	<property name="build" value="build"/>
    </target>

    <property name="builddir" location="${build}"/>

    <target name="rmic-init"
	    depends="property-rmic-build,property-init"/>

    <target name="rmic"
	    depends="rmic-init">
	    <!-- Commented out; not toplevel.
	    description="Preprocess class files in the build tree for RMI"
	    -->
	<!-- <echo message="Do ONLY the class files in ibis/ipl"/> -->

	<if>
	    <isset property="rmic-flags"/>
	    <then>
		<property name="rmic-flags.value" value="${rmic-flags}"/>
	    </then>
	    <else>
		<property name="rmic-flags.value" value=""/>
	    </else>
	</if>
	<path id="all-classes">
	    <fileset dir="${builddir}">
		<include name="**/*.class"/>
		<include name="ibis/ipl/*.class"/>
	    </fileset>
	</path>
	<pathconvert pathsep=" " property="classes.all" refid="all-classes">
	    <map from="${builddir}${file.separator}" to=""/>
	</pathconvert>

	<!--
	    Do regexp on ${classes.all} -> rmic-classes
		%s/.class//g
		%s/\${file.separator}/./g
	-->
	<echo message="${classes.all}" file="${build}/RMIC-Classes"/>
	<replaceregexp
		byline="true"
		file="${build}/RMIC-Classes"
		flags="g"
		match=".class"
		replace=""/>
	<replaceregexp
		byline="true"
		file="${build}/RMIC-Classes"
		flags="g"
		match="\${file.separator}"
		replace="."/>
	<loadfile
		property="rmic-classes"
		srcFile="${build}/RMIC-Classes">
	</loadfile>

	<echo	level="debug"
		message="All classes to be rewritten: ${rmic-classes}"/>
	<echo	level="debug"
		message="Run ibis rmic over all classes under ${builddir}${file.separator}"/>
	<java   classname="ibis.frontend.rmi.Main"
		taskname="ibis rmic"
		dir="${builddir}"
		failonerror="true"
		fork="true">
		<arg line="${rmic-flags.value} -dir -java2ibis ${rmic-classes}"/>
	    <classpath refid="default.classpath"/>
	</java>
	<javac	destdir="${builddir}"
		srcdir="${builddir}">
	    <include name="**/rmi_stub_*.java"/>
	    <include name="**/rmi_skeleton_*.java"/>
	    <classpath refid="default.classpath"/>
	</javac>
    </target>

    <target name="rmic-sun"
	    depends="property-init">
	    <!-- Commented out; not toplevel.
	    description="Preprocess class files in the build tree for SUN RMI"
	    -->

	<path id="all-classes">
	    <fileset dir="${builddir}">
		<include name="**/*.class"/>
	    </fileset>
	</path>
	<pathconvert pathsep=" " property="classes.all" refid="all-classes">
	    <map from="${builddir}${file.separator}" to=""/>
	</pathconvert>

	<!--
	    Do regexp on ${classes.all} -> rmic-classes
		%s/.class//g
		%s/\${file.separator}/./g
	-->
	<echo message="${classes.all}" file="${build}/-RMIC-Classes"/>
	<replaceregexp
		byline="true"
		file="${build}/-RMIC-Classes"
		flags="g"
		match=".class"
		replace=""/>
	<replaceregexp
		byline="true"
		file="${build}/-RMIC-Classes"
		flags="g"
		match="\${file.separator}"
		replace="."/>
	<loadfile
		property="rmic-classes"
		srcFile="${build}/-RMIC-Classes">
	</loadfile>

	<echo   level="debug"
		message="All classes to be inspected: ${rmic-classes}"/>
	<echo   level="debug"
		message="Run frontend.rmi.Main -n -java over all classes under ${builddir}${file.separator}"/>
	<java   classname="ibis.frontend.rmi.Main"
		taskname="rmic locator"
		dir="${builddir}"
		failonerror="true"
		fork="true"
		output="${build}/-REMOTE-Classes">
	    <arg line="-n -java ${rmic-classes}"/>
	    <classpath refid="default.classpath"/>
	</java>

	<!--
	    Do regexp on ${rmic-classes} -> remote-classes
		%s/\${line.separator/.class /g
		%s/ $//g
	-->
	<replaceregexp
		file="${build}/-REMOTE-Classes"
		flags="g"
		match="\${line.separator}"
		replace=".class "/>
	<replaceregexp
		file="${build}/-REMOTE-Classes"
		flags="g"
		match=" $"
		replace=""/>
	<loadfile
		property="remote.classes"
		srcFile="${build}/-REMOTE-Classes"/>

	<echo   level="debug"
		message="Now run sun.rmic over '${remote.classes}'"/>
	<rmic   base="${builddir}"
		includes="${remote.classes}">
	    <classpath refid="default.classpath"/>
	</rmic>
    </target>


    <property name="karmi" location="${ibis}/karmi/karmi-transport-1.07g"/>

    <target name="rmic-karmi"
	    depends="property-init">
	    <!-- Commented out; not toplevel.
	    description="Preprocess class files in the build tree for SUN RMI"
	    -->

	<path id="all-classes">
	    <fileset dir="${builddir}">
		<include name="**/*.class"/>
	    </fileset>
	</path>
	<pathconvert pathsep=" " property="classes.all" refid="all-classes">
	    <map from="${builddir}${file.separator}" to=""/>
	</pathconvert>

	<!--
	    Do regexp on ${classes.all} -> rmic-classes
		%s/.class//g
		%s/\${file.separator}/./g
	-->
	<echo message="${classes.all}" file="${build}/-RMIC-Classes"/>
	<replaceregexp
		byline="true"
		file="${build}/-RMIC-Classes"
		flags="g"
		match=".class"
		replace=""/>
	<replaceregexp
		byline="true"
		file="${build}/-RMIC-Classes"
		flags="g"
		match="\${file.separator}"
		replace="."/>
	<loadfile
		property="rmic-classes"
		srcFile="${build}/-RMIC-Classes">
	</loadfile>

	<echo   level="warning"
		message="All classes to be inspected: ${rmic-classes}"/>
	<echo   level="warning"
		message="Run frontend.rmi.Main -n -karmi over all classes under ${builddir}${file.separator}"/>
	<java   classname="ibis.frontend.rmi.Main"
		taskname="rmic locator"
		dir="${builddir}"
		failonerror="true"
		fork="true"
		output="${build}/-REMOTE-Classes">
	    <arg line="-n -karmi ${rmic-classes}"/>
	    <classpath refid="default.classpath"/>
	</java>

	<loadfile
		property="remote.classes"
		srcFile="${build}/-REMOTE-Classes"/>

	<echo   level="warning"
		message="Now run karmic over '${remote.classes}'"/>
	<property name="expanded-classpath" refid="default.classpath"/>
	<exec	executable="${karmi}/bin/karmic">
	      <arg line="-classpath ${expanded-classpath} -d ${builddir} ${remote.classes}"/>
	</exec>
	<!--
	<rmic   base="${builddir}"
		includes="${remote.classes}"
		compiler="${ibis}/karmi/karmi-transport-1.07g/bin/karmic">
	    <classpath refid="default.classpath"/>
	</rmic>
	-->
    </target>

    <target name="init" depends="property-init">
	<tstamp/>
	<mkdir dir="${builddir}"/>
	<!--
	<echo message="os.name = ${os.name} os.arch = ${os.arch}"/>
	<echo message="user.name = ${user.name} user.dir = ${user.dir}"/>
	<echo message="java.ext.dirs = ${java.ext.dirs}"/>
	-->
    </target>

    <target name="compile"
	depends="clean,init,property-init">
	<property name="class-path" refid="default.classpath"/>
	<echo   message="class path ${class-path}"/>

	<javac  destdir="${builddir}"
		debug="${java.debug.value}"
		srcdir=".:../shared">
	    <classpath refid="default.classpath"/>
	    <include name="**/*.java"/>
	</javac>
    </target>

    <target name="build"
	    depends="init"
	    description="Compile RMI application for Ibis RMI">
	<antcall inheritAll="true" inheritRefs="true" target="compile"/>
	<antcall inheritRefs="true" target="rmic"/>
	<antcall inheritRefs="true" target="iogen"/>
    </target>

    <target name="build-sun"
	    depends="init"
	    description="Compile RMI application for Sun RMI">
	<antcall inheritAll="true" inheritRefs="true" target="compile"/>
	<antcall inheritRefs="true" target="rmic-sun"/>
    </target>

    <target name="build-karmi"
	    depends="init"
	    description="Compile RMI application for KaRMI">
	<replace
		dir="."
		token="java.rmi."
		value="uka.karmi.rmi."/>
	<replace
		dir="."
		token="uka.karmi.rmi.RMISecurityManager"
		value="java.rmi.RMISecurityManager"/>
	<if>
	    <available file="${karmi}/karmi.jar"/>
	    <then>
		<path id="extra-classpath">
		    <pathelement path="${karmi}/karmi.jar"/>
		</path>
	    </then>
	    <else>
		<path id="extra-classpath"/>
	    </else>
	</if>
	<antcall inheritAll="false" inheritRefs="false" target="compile">
	    <reference refid="extra-classpath"/>
	</antcall>
	<antcall inheritAll="false" inheritRefs="false" target="rmic-karmi">
	    <reference refid="extra-classpath"/>
	</antcall>

	<replace
		dir="."
		token="uka.karmi.rmi"
		value="java.rmi"/>
    </target>

    <target name="clean"
	    description="Clean up the build">
	<delete dir="${build}"/>
    </target>

</project>
